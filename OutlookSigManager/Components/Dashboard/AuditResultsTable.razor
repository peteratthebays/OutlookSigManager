@using OutlookSigManager.Models

<div class="audit-results-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="filter-buttons btn-group" role="group">
            <button type="button"
                    class="btn @(CurrentFilter == null ? "btn-primary" : "btn-outline-primary")"
                    @onclick="() => SetFilter(null)">
                All (@Results.Count)
            </button>
            <button type="button"
                    class="btn @(CurrentFilter == SignatureStatus.Match ? "btn-success" : "btn-outline-success")"
                    @onclick="() => SetFilter(SignatureStatus.Match)">
                Compliant (@Results.Count(r => r.Status == SignatureStatus.Match))
            </button>
            <button type="button"
                    class="btn @(CurrentFilter == SignatureStatus.Missing ? "btn-danger" : "btn-outline-danger")"
                    @onclick="() => SetFilter(SignatureStatus.Missing)">
                Missing (@Results.Count(r => r.Status == SignatureStatus.Missing))
            </button>
            <button type="button"
                    class="btn @(CurrentFilter == SignatureStatus.Inconsistent ? "btn-warning" : "btn-outline-warning")"
                    @onclick="() => SetFilter(SignatureStatus.Inconsistent)">
                Issues (@Results.Count(r => r.Status == SignatureStatus.Inconsistent || r.Status == SignatureStatus.Outdated))
            </button>
            <button type="button"
                    class="btn @(CurrentFilter == SignatureStatus.NotAccessible ? "btn-info" : "btn-outline-info")"
                    @onclick="() => SetFilter(SignatureStatus.NotAccessible)">
                Not Accessible (@Results.Count(r => r.Status == SignatureStatus.NotAccessible))
            </button>
        </div>

        <div class="search-box">
            <input type="text"
                   class="form-control"
                   placeholder="Search users..."
                   @bind="SearchTerm"
                   @bind:event="oninput" />
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th scope="col">User</th>
                    <th scope="col">Email</th>
                    <th scope="col">Department</th>
                    <th scope="col">Status</th>
                    <th scope="col">Discrepancies</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var result in FilteredResults)
                {
                    <tr class="@GetRowClass(result.Status)">
                        <td>
                            <div class="user-info">
                                <strong>@result.User.DisplayName</strong>
                                @if (!string.IsNullOrEmpty(result.User.JobTitle))
                                {
                                    <br /><small class="text-muted">@result.User.JobTitle</small>
                                }
                            </div>
                        </td>
                        <td>@result.User.Mail</td>
                        <td>@result.User.Department</td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(result.Status)">
                                @GetStatusText(result.Status)
                            </span>
                        </td>
                        <td>
                            @if (result.Discrepancies.Any())
                            {
                                <ul class="discrepancy-list mb-0">
                                    @foreach (var disc in result.Discrepancies.Take(2))
                                    {
                                        <li>@disc.Description</li>
                                    }
                                    @if (result.Discrepancies.Count > 2)
                                    {
                                        <li class="text-muted">+@(result.Discrepancies.Count - 2) more...</li>
                                    }
                                </ul>
                            }
                            else if (!string.IsNullOrEmpty(result.ErrorMessage))
                            {
                                <span class="text-danger">@result.ErrorMessage</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="() => OnViewDetails.InvokeAsync(result)">
                                View Details
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!FilteredResults.Any())
    {
        <div class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-1"></i>
            <p>No results match the current filter.</p>
        </div>
    }
</div>

@code {
    [Parameter]
    public IReadOnlyList<SignatureAuditResult> Results { get; set; } = Array.Empty<SignatureAuditResult>();

    [Parameter]
    public EventCallback<SignatureAuditResult> OnViewDetails { get; set; }

    private SignatureStatus? CurrentFilter { get; set; }
    private string SearchTerm { get; set; } = string.Empty;

    private IEnumerable<SignatureAuditResult> FilteredResults
    {
        get
        {
            var filtered = Results.AsEnumerable();

            if (CurrentFilter.HasValue)
            {
                if (CurrentFilter == SignatureStatus.Inconsistent)
                {
                    filtered = filtered.Where(r =>
                        r.Status == SignatureStatus.Inconsistent ||
                        r.Status == SignatureStatus.Outdated);
                }
                else
                {
                    filtered = filtered.Where(r => r.Status == CurrentFilter.Value);
                }
            }

            if (!string.IsNullOrWhiteSpace(SearchTerm))
            {
                var term = SearchTerm.ToLowerInvariant();
                filtered = filtered.Where(r =>
                    (r.User.DisplayName?.ToLowerInvariant().Contains(term) ?? false) ||
                    (r.User.Mail?.ToLowerInvariant().Contains(term) ?? false) ||
                    (r.User.Department?.ToLowerInvariant().Contains(term) ?? false));
            }

            return filtered;
        }
    }

    private void SetFilter(SignatureStatus? status)
    {
        CurrentFilter = status;
    }

    private static string GetStatusBadgeClass(SignatureStatus status) => status switch
    {
        SignatureStatus.Match => "bg-success",
        SignatureStatus.Missing => "bg-danger",
        SignatureStatus.Outdated => "bg-warning text-dark",
        SignatureStatus.Inconsistent => "bg-warning text-dark",
        SignatureStatus.Error => "bg-danger",
        SignatureStatus.NotAccessible => "bg-info",
        _ => "bg-secondary"
    };

    private static string GetStatusText(SignatureStatus status) => status switch
    {
        SignatureStatus.Match => "Compliant",
        SignatureStatus.Missing => "Missing",
        SignatureStatus.Outdated => "Outdated",
        SignatureStatus.Inconsistent => "Inconsistent",
        SignatureStatus.Error => "Error",
        SignatureStatus.NotAccessible => "Not Accessible",
        _ => "Unknown"
    };

    private static string GetRowClass(SignatureStatus status) => status switch
    {
        SignatureStatus.Match => "",
        SignatureStatus.Missing => "table-danger",
        SignatureStatus.Outdated or SignatureStatus.Inconsistent => "table-warning",
        SignatureStatus.Error => "table-danger",
        SignatureStatus.NotAccessible => "table-info",
        _ => ""
    };
}
