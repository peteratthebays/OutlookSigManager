@using OutlookSigManager.Models

@if (IsVisible && Result != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Signature Details - @Result.User.DisplayName
                    </h5>
                    <button type="button" class="btn-close" @onclick="Close" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">User Profile</h6>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <th scope="row">Display Name</th>
                                        <td>@Result.User.DisplayName</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Email</th>
                                        <td>@Result.User.Mail</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Job Title</th>
                                        <td>@(Result.User.JobTitle ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Department</th>
                                        <td>@(Result.User.Department ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Business Phone</th>
                                        <td>@(Result.User.BusinessPhone ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Mobile Phone</th>
                                        <td>@(Result.User.MobilePhone ?? "-")</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Audit Status</h6>
                            <div class="mb-3">
                                <span class="badge @GetStatusBadgeClass(Result.Status) fs-6">
                                    @GetStatusText(Result.Status)
                                </span>
                            </div>

                            @if (Result.Discrepancies.Any())
                            {
                                <h6 class="text-muted mb-2">Discrepancies Found</h6>
                                <ul class="list-group">
                                    @foreach (var disc in Result.Discrepancies)
                                    {
                                        <li class="list-group-item">
                                            <strong>@disc.Field:</strong> @disc.Description
                                            @if (!string.IsNullOrEmpty(disc.ExpectedValue) && !string.IsNullOrEmpty(disc.ActualValue))
                                            {
                                                <br />
                                                <small class="text-muted">
                                                    Expected: <code>@disc.ExpectedValue</code> |
                                                    Actual: <code>@disc.ActualValue</code>
                                                </small>
                                            }
                                        </li>
                                    }
                                </ul>
                            }

                            @if (!string.IsNullOrEmpty(Result.ErrorMessage))
                            {
                                <div class="alert alert-danger mt-3">
                                    <strong>Error:</strong> @Result.ErrorMessage
                                </div>
                            }
                        </div>
                    </div>

                    <hr />

                    <h6 class="text-muted mb-3">Signature Comparison</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-check-circle me-2"></i>Expected Signature
                                </div>
                                <div class="card-body signature-preview">
                                    @if (!string.IsNullOrEmpty(Result.ExpectedSignatureHtml))
                                    {
                                        @((MarkupString)Result.ExpectedSignatureHtml)
                                    }
                                    else
                                    {
                                        <span class="text-muted">No expected signature generated</span>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header @GetCurrentSignatureHeaderClass()">
                                    <i class="bi @GetCurrentSignatureIcon() me-2"></i>Current Signature
                                </div>
                                <div class="card-body signature-preview">
                                    @if (!string.IsNullOrEmpty(Result.CurrentSignatureHtml))
                                    {
                                        @((MarkupString)Result.CurrentSignatureHtml)
                                    }
                                    else if (Result.Status == SignatureStatus.NotAccessible)
                                    {
                                        <div class="alert alert-info mb-0">
                                            <i class="bi bi-info-circle me-2"></i>
                                            Signature content is not accessible via the Microsoft Graph v1.0 API.
                                            This is a known limitation.
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No signature found</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public SignatureAuditResult? Result { get; set; }

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private static string GetStatusBadgeClass(SignatureStatus status) => status switch
    {
        SignatureStatus.Match => "bg-success",
        SignatureStatus.Missing => "bg-danger",
        SignatureStatus.Outdated => "bg-warning text-dark",
        SignatureStatus.Inconsistent => "bg-warning text-dark",
        SignatureStatus.Error => "bg-danger",
        SignatureStatus.NotAccessible => "bg-info",
        _ => "bg-secondary"
    };

    private static string GetStatusText(SignatureStatus status) => status switch
    {
        SignatureStatus.Match => "Compliant",
        SignatureStatus.Missing => "Missing",
        SignatureStatus.Outdated => "Outdated",
        SignatureStatus.Inconsistent => "Inconsistent",
        SignatureStatus.Error => "Error",
        SignatureStatus.NotAccessible => "Not Accessible",
        _ => "Unknown"
    };

    private string GetCurrentSignatureHeaderClass() => Result?.Status switch
    {
        SignatureStatus.Match => "bg-success text-white",
        SignatureStatus.Missing => "bg-danger text-white",
        SignatureStatus.Outdated or SignatureStatus.Inconsistent => "bg-warning text-dark",
        SignatureStatus.NotAccessible => "bg-info text-white",
        _ => "bg-secondary text-white"
    };

    private string GetCurrentSignatureIcon() => Result?.Status switch
    {
        SignatureStatus.Match => "bi-check-circle",
        SignatureStatus.Missing => "bi-x-circle",
        SignatureStatus.Outdated or SignatureStatus.Inconsistent => "bi-exclamation-triangle",
        SignatureStatus.NotAccessible => "bi-lock",
        _ => "bi-question-circle"
    };
}
