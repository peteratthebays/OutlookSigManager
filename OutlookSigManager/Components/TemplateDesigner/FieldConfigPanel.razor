@namespace OutlookSigManager.Components.TemplateDesigner
@using OutlookSigManager.Models

<div class="card mb-3">
    <div class="card-header">
        <i class="bi bi-list-check me-2"></i>Fields
    </div>
    <div class="card-body p-0">
        <ul class="list-group list-group-flush">
            @foreach (var field in Design.Fields.OrderBy(f => f.SortOrder))
            {
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   checked="@field.IsEnabled"
                                   @onchange="e => OnFieldEnabledChanged(field, e)"
                                   id="field-@field.FieldId" />
                            <label class="form-check-label fw-semibold" for="field-@field.FieldId">
                                @field.DisplayLabel
                                @if (field.IsCustomField)
                                {
                                    <span class="badge bg-info ms-1">Custom</span>
                                }
                            </label>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary"
                                    type="button"
                                    @onclick="() => MoveFieldUp(field)"
                                    disabled="@(field.SortOrder <= 1)"
                                    title="Move up">
                                <i class="bi bi-arrow-up"></i>
                            </button>
                            <button class="btn btn-outline-secondary"
                                    type="button"
                                    @onclick="() => MoveFieldDown(field)"
                                    disabled="@(field.SortOrder >= Design.Fields.Count)"
                                    title="Move down">
                                <i class="bi bi-arrow-down"></i>
                            </button>
                        </div>
                    </div>

                    @if (field.IsEnabled)
                    {
                        <div class="ps-4 pt-2 border-top">
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="form-label small mb-1">Prefix</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           placeholder="e.g., P: "
                                           value="@field.Prefix"
                                           @onchange="e => OnPrefixChanged(field, e)" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label small mb-1">Font Size</label>
                                    <select class="form-select form-select-sm"
                                            value="@(field.FontSize ?? "")"
                                            @onchange="e => OnFontSizeChanged(field, e)">
                                        <option value="">Default</option>
                                        <option value="8pt">8pt</option>
                                        <option value="9pt">9pt</option>
                                        <option value="10pt">10pt</option>
                                        <option value="11pt">11pt</option>
                                        <option value="12pt">12pt</option>
                                        <option value="14pt">14pt</option>
                                        <option value="16pt">16pt</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="form-label small mb-1">Color</label>
                                    <div class="input-group input-group-sm">
                                        <input type="color"
                                               class="form-control form-control-color form-control-sm"
                                               value="@(field.Color ?? Design.SecondaryColor)"
                                               @onchange="e => OnColorChanged(field, e)"
                                               style="max-width: 40px;" />
                                        <input type="text"
                                               class="form-control form-control-sm"
                                               placeholder="Default"
                                               value="@(field.Color ?? "")"
                                               @onchange="e => OnColorTextChanged(field, e)" />
                                        @if (!string.IsNullOrEmpty(field.Color))
                                        {
                                            <button class="btn btn-outline-secondary btn-sm"
                                                    type="button"
                                                    @onclick="() => ClearFieldColor(field)"
                                                    title="Reset to default">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                                <div class="col-6 d-flex align-items-end">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               checked="@field.IsBold"
                                               @onchange="e => OnBoldChanged(field, e)"
                                               id="bold-@field.FieldId" />
                                        <label class="form-check-label small" for="bold-@field.FieldId">
                                            <strong>Bold</strong>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            @if (field.IsCustomField)
                            {
                                <div class="mb-2">
                                    <label class="form-label small mb-1">Default Value</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           placeholder="e.g., Mon-Fri"
                                           value="@field.DefaultValue"
                                           @onchange="e => OnDefaultValueChanged(field, e)" />
                                </div>
                            }
                        </div>
                    }
                </li>
            }
        </ul>
    </div>
</div>

@code {
    [Parameter] public TemplateDesign Design { get; set; } = new();
    [Parameter] public EventCallback<TemplateDesign> DesignChanged { get; set; }

    private async Task NotifyDesignChanged()
    {
        await DesignChanged.InvokeAsync(Design);
    }

    private async Task OnFieldEnabledChanged(TemplateField field, ChangeEventArgs e)
    {
        field.IsEnabled = (bool)(e.Value ?? false);
        await NotifyDesignChanged();
    }

    private async Task OnPrefixChanged(TemplateField field, ChangeEventArgs e)
    {
        field.Prefix = e.Value?.ToString();
        await NotifyDesignChanged();
    }

    private async Task OnBoldChanged(TemplateField field, ChangeEventArgs e)
    {
        field.IsBold = (bool)(e.Value ?? false);
        await NotifyDesignChanged();
    }

    private async Task OnDefaultValueChanged(TemplateField field, ChangeEventArgs e)
    {
        field.DefaultValue = e.Value?.ToString();
        await NotifyDesignChanged();
    }

    private async Task OnFontSizeChanged(TemplateField field, ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        field.FontSize = string.IsNullOrEmpty(value) ? null : value;
        await NotifyDesignChanged();
    }

    private async Task OnColorChanged(TemplateField field, ChangeEventArgs e)
    {
        field.Color = e.Value?.ToString();
        await NotifyDesignChanged();
    }

    private async Task OnColorTextChanged(TemplateField field, ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        field.Color = string.IsNullOrWhiteSpace(value) ? null : value;
        await NotifyDesignChanged();
    }

    private async Task ClearFieldColor(TemplateField field)
    {
        field.Color = null;
        await NotifyDesignChanged();
    }

    private async Task MoveFieldUp(TemplateField field)
    {
        var currentOrder = field.SortOrder;
        if (currentOrder <= 1) return;

        var swapField = Design.Fields.FirstOrDefault(f => f.SortOrder == currentOrder - 1);
        if (swapField != null)
        {
            swapField.SortOrder = currentOrder;
            field.SortOrder = currentOrder - 1;
            await NotifyDesignChanged();
        }
    }

    private async Task MoveFieldDown(TemplateField field)
    {
        var currentOrder = field.SortOrder;
        if (currentOrder >= Design.Fields.Count) return;

        var swapField = Design.Fields.FirstOrDefault(f => f.SortOrder == currentOrder + 1);
        if (swapField != null)
        {
            swapField.SortOrder = currentOrder;
            field.SortOrder = currentOrder + 1;
            await NotifyDesignChanged();
        }
    }
}
