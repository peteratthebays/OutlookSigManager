@page "/signature-creator"
@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using OutlookSigManager.Models
@using OutlookSigManager.Services
@using OutlookSigManager.Components.SignatureCreator
@attribute [Authorize]
@rendermode InteractiveServer
@inject IGraphUserService GraphUserService
@inject IUserOverrideStorageService OverrideStorage
@inject ILogger<SignatureCreator> Logger
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Signature Creator - Baysig</PageTitle>

<div class="container-fluid py-4 px-4">
    <div class="text-center mb-4">
        <h1 class="h2 mb-2">Create Your Email Signature</h1>
        <p class="text-muted">Generate a professional email signature using your company profile</p>
    </div>

    @if (ErrorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = null" aria-label="Close"></button>
        </div>
    }

    @if (IsLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted">Loading your profile...</p>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-4 col-xl-3">
                <UserProfileForm User="@CurrentUser"
                                Overrides="@FieldOverrides"
                                OverridesChanged="@OnOverridesChanged"
                                OnSaveRequested="@SaveOverrides"
                                HasSavedOverrides="@HasSavedOverrides"
                                IsSaving="@IsSaving"
                                SaveSuccess="@SaveSuccess"
                                SaveError="@SaveError" />
            </div>
            <div class="col-lg-8 col-xl-9">
                <div class="sticky-top" style="top: 20px;">
                    <SignaturePreview User="@EffectiveUser"
                                     Overrides="@FieldOverrides" />
                </div>
            </div>
        </div>
    }
</div>

@code {
    private UserProfile? CurrentUser { get; set; }
    private SignatureFieldOverride FieldOverrides { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private string? ErrorMessage { get; set; }

    // Save state
    private bool HasSavedOverrides { get; set; }
    private bool IsSaving { get; set; }
    private bool SaveSuccess { get; set; }
    private string? SaveError { get; set; }

    private UserProfile? EffectiveUser => CurrentUser != null
        ? FieldOverrides.ApplyToProfile(CurrentUser)
        : null;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
    }

    private async Task LoadCurrentUser()
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            // Get user email from authentication claims
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            var email = user.FindFirst("preferred_username")?.Value
                     ?? user.FindFirst(ClaimTypes.Email)?.Value
                     ?? user.FindFirst("email")?.Value;

            if (string.IsNullOrEmpty(email))
            {
                Logger.LogWarning("Could not find email claim for current user");
                ErrorMessage = "Unable to determine your email address. Please sign out and sign in again.";
                return;
            }

            Logger.LogInformation("Loading profile for user: {Email}", email);
            CurrentUser = await GraphUserService.GetUserByEmailAsync(email);

            if (CurrentUser == null)
            {
                Logger.LogWarning("GetUserByEmailAsync returned null for {Email}", email);
                ErrorMessage = "Unable to load your profile. Please try refreshing the page or signing in again.";
            }
            else
            {
                Logger.LogInformation("Loaded profile for {DisplayName}", CurrentUser.DisplayName);

                // Load saved overrides from local database
                await LoadSavedOverrides();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading current user");
            ErrorMessage = $"Failed to load your profile: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadSavedOverrides()
    {
        if (CurrentUser == null) return;

        try
        {
            var savedOverride = await OverrideStorage.GetOverrideAsync(CurrentUser.Id);
            if (savedOverride != null)
            {
                FieldOverrides = savedOverride.ToFieldOverride();
                HasSavedOverrides = true;
                Logger.LogInformation("Loaded saved overrides for user {UserId}", CurrentUser.Id);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading saved overrides for user {UserId}", CurrentUser?.Id);
            // Don't fail - just use empty overrides
        }
    }

    private async Task SaveOverrides()
    {
        if (CurrentUser == null || IsSaving) return;

        IsSaving = true;
        SaveSuccess = false;
        SaveError = null;

        try
        {
            var userOverride = new UserOverride { UserId = CurrentUser.Id };
            userOverride.UpdateFrom(FieldOverrides);

            await OverrideStorage.SaveOverrideAsync(userOverride);

            HasSavedOverrides = true;
            SaveSuccess = true;
            Logger.LogInformation("Saved overrides for user {UserId}", CurrentUser.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving overrides for user {UserId}", CurrentUser?.Id);
            SaveError = $"Failed to save: {ex.Message}";
        }
        finally
        {
            IsSaving = false;
        }
    }

    private async Task OnOverridesChanged(SignatureFieldOverride overrides)
    {
        FieldOverrides = overrides;
        SaveSuccess = false; // Clear success message when changes are made
        await Task.CompletedTask;
    }
}
