@namespace OutlookSigManager.Components.SignatureCreator
@using OutlookSigManager.Models
@using OutlookSigManager.Services
@inject ISignatureTemplateService TemplateService
@inject ITemplateStorageService TemplateStorage
@inject IJSRuntime JSRuntime

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-eye me-2"></i>Your Signature Preview</span>
        <button class="btn btn-outline-secondary btn-sm" @onclick="RefreshPreview" title="Refresh preview">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
    </div>
    <div class="card-body">
        <div class="border rounded p-4 bg-white mb-3" style="min-height: 150px; overflow-x: auto;">
            @if (IsLoading)
            {
                <div class="text-center py-3">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Loading preview...
                </div>
            }
            else if (User == null)
            {
                <p class="text-muted fst-italic mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Sign in to see your personalized signature preview.
                </p>
            }
            else if (!string.IsNullOrEmpty(SignatureHtml))
            {
                <div style="display: inline-block;">
                    @((MarkupString)SignatureHtml)
                </div>
            }
            else
            {
                <p class="text-muted fst-italic mb-0">Unable to generate preview.</p>
            }
        </div>

        <div class="d-grid gap-2">
            <button class="btn btn-success btn-lg"
                    @onclick="CopyToClipboard"
                    disabled="@(string.IsNullOrEmpty(SignatureHtml) || IsCopying)">
                @if (IsCopying)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                else if (CopySuccess)
                {
                    <i class="bi bi-check-lg me-2"></i>
                }
                else
                {
                    <i class="bi bi-clipboard-check me-2"></i>
                }
                @(CopySuccess ? "Copied!" : "Copy Signature to Clipboard")
            </button>
        </div>

        @if (CopySuccess)
        {
            <div class="alert alert-success mt-3 mb-0">
                <i class="bi bi-check-circle-fill me-2"></i><strong>Signature copied to clipboard!</strong> Follow the instructions below to set it up in Outlook.
            </div>
        }

        <!-- Instructions Section -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="bi bi-question-circle me-2"></i>How to Set Up Your Signature</h5>

            <!-- Modern/Web Outlook -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-globe me-2"></i>Outlook on the Web / New Outlook (Modern)
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li>Open <a href="https://outlook.office.com" target="_blank">outlook.office.com</a> or the <strong>New Outlook</strong> desktop app</li>
                        <li>Click the <strong>Settings</strong> cog icon (<i class="bi bi-gear"></i>) in the top-right corner</li>
                        <li>Select <strong>Account</strong> from the left menu, then click <strong>Signatures</strong></li>
                        <li>Click <strong>+ New signature</strong> or select an existing signature to edit
                            <ul>
                                <li>If editing, select all (Ctrl+A) and delete the existing content first</li>
                            </ul>
                        </li>
                        <li>Click inside the signature editor and press <strong>Ctrl+V</strong> (or <strong>Cmd+V</strong> on Mac) to paste</li>
                        <li>At the bottom, set your <strong>default signatures</strong>:
                            <ul>
                                <li><em>For new messages</em> - select your signature</li>
                                <li><em>For replies/forwards</em> - select your signature (optional)</li>
                            </ul>
                        </li>
                        <li>Click <strong>Save</strong></li>
                    </ol>
                </div>
            </div>

            <!-- Classic Outlook -->
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <i class="bi bi-window-desktop me-2"></i>Classic Outlook (Desktop)
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li>Open <strong>Outlook</strong> desktop application</li>
                        <li>Click <strong>File</strong> <i class="bi bi-arrow-right"></i> <strong>Options</strong></li>
                        <li>Select <strong>Mail</strong> from the left panel</li>
                        <li>Click the <strong>Signatures...</strong> button</li>
                        <li>In the Signatures and Stationery window:
                            <ul>
                                <li>Click <strong>New</strong> to create a new signature, or select an existing one to edit</li>
                                <li>Give it a name (e.g., "Work Signature")</li>
                            </ul>
                        </li>
                        <li>Click inside the signature editor at the bottom and press <strong>Ctrl+V</strong> to paste</li>
                        <li>Under <strong>Choose default signature</strong>:
                            <ul>
                                <li>Set <strong>New messages</strong> to your signature name</li>
                                <li>Set <strong>Replies/forwards</strong> to your signature name (optional)</li>
                            </ul>
                        </li>
                        <li>Click <strong>OK</strong> to save</li>
                    </ol>
                </div>
            </div>

            <div class="alert alert-info mb-0">
                <i class="bi bi-lightbulb me-2"></i><strong>Tip:</strong> If images don't appear correctly, make sure you're pasting with formatting (Ctrl+V), not as plain text (Ctrl+Shift+V).
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public UserProfile? User { get; set; }
    [Parameter] public SignatureFieldOverride? Overrides { get; set; }

    private string? SignatureHtml { get; set; }
    private bool IsLoading { get; set; }
    private bool IsCopying { get; set; }
    private bool CopySuccess { get; set; }
    private TemplateDesign? _currentDesign;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplate();
    }

    protected override async Task OnParametersSetAsync()
    {
        await RefreshPreview();
    }

    private async Task LoadTemplate()
    {
        try
        {
            _currentDesign = await TemplateStorage.GetTemplateAsync();
        }
        catch
        {
            _currentDesign = TemplateDesign.CreateDefault();
        }
    }

    private async Task RefreshPreview()
    {
        if (User == null)
        {
            SignatureHtml = null;
            return;
        }

        IsLoading = true;
        CopySuccess = false;

        try
        {
            if (_currentDesign == null)
            {
                await LoadTemplate();
            }

            if (_currentDesign != null)
            {
                SignatureHtml = TemplateService.GenerateHtmlFromDesign(_currentDesign, User, Overrides);
            }
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task CopyToClipboard()
    {
        if (string.IsNullOrEmpty(SignatureHtml) || IsCopying) return;

        IsCopying = true;
        CopySuccess = false;

        try
        {
            await JSRuntime.InvokeVoidAsync("copyHtmlToClipboard", SignatureHtml);
            CopySuccess = true;
        }
        catch
        {
            // Could add error handling here
        }
        finally
        {
            IsCopying = false;
        }
    }
}
